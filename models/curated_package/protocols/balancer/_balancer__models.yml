version: 2

models:
  # Root-level Balancer models
  - name: silver_protocols__balancer_ethereum_revenue_by_token
    description: >
      Tracks revenue collected by Balancer protocol fee collector on Ethereum.
      Fee collector address: 0xce88686553686DA562CE7Cea497CE749DA109f9F (Balancer v2 Protocol Fee Collector).
      Note: This model is currently incomplete - there are missing fees.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - contract_address
    columns:
      - name: date
        tests:
          - not_null
      - name: contract_address
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_token_incentives
    description: >
      Tracks BAL token incentives distributed from Merkle Redeem contract.
      Merkle Redeem: 0x6d19b2bf3a36a61530909ae65445a906d98a2fa8.
      BAL token: 0xba100000625a3754423978a60c9317c58a424e3D.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - contract_address
    columns:
      - name: date
        tests:
          - not_null
      - name: contract_address
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_token_incentives_all_chains
    description: >
      Tracks BAL token incentives across Ethereum, Arbitrum, and Polygon from various
      Merkle Orchard contracts. Includes emissions from minting events.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - chain
    columns:
      - name: date
        tests:
          - not_null
      - name: chain
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_treasury_by_token
    description: >
      Tracks token balances in Balancer treasury addresses including Protocol Fee Collector,
      DAO Multisig, Treasury, and LM Multisig. Active since June 23, 2020.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - token_address
    columns:
      - name: date
        tests:
          - not_null
      - name: token_address
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  # V1 Models
  - name: silver_protocols__balancer_v1_ethereum_bpools
    description: >
      Tracks Balancer V1 pool creation events from the Core Pool Factory.
      Factory address: 0x9424B1412450D0f8Fc2255FAf6046b98213B76Bd.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - block_timestamp
            - pool
    columns:
      - name: block_timestamp
        tests:
          - not_null
      - name: pool
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v1_ethereum_bpool_swaps
    description: >
      Tracks LOG_SWAP events from Balancer V1 pools on Ethereum.
      Joins with BPools model to get pool addresses.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - tx_hash
            - event_index
    columns:
      - name: tx_hash
        tests:
          - not_null
      - name: event_index
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v1_swaps
    description: >
      Enriched swap data for Balancer V1 with USD values and fee calculations.
      Joins with price data and swap fee configurations.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - tx_hash
            - event_index
    columns:
      - name: block_timestamp
        tests:
          - not_null
      - name: tx_hash
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v1_tvl
    description: >
      Tracks total value locked in Balancer V1 pools by token on Ethereum.
      Uses address balances and price data to calculate TVL.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - pool_address
            - token_address
    columns:
      - name: date
        tests:
          - not_null
      - name: pool_address
        tests:
          - not_null
      - name: token_address
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  # =============================================================================
  # V2 Cross-Chain Models (work across all chains via GLOBAL_PROJECT_NAME)
  # Canonical Vault address: 0xba12222222228d8ba445958a75a0704d566bf2c8
  # V2 chains: ethereum, polygon, arbitrum, gnosis
  # =============================================================================

  - name: silver_protocols__balancer_v2_swaps
    description: >
      Tracks Swap events from Balancer V2 Vault contract.
      Works across all chains - uses GLOBAL_PROJECT_NAME for chain identification.
      V2 chains: ethereum, polygon, arbitrum, gnosis
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - tx_hash
            - event_index
    columns:
      - name: tx_hash
        tests:
          - not_null
      - name: event_index
        tests:
          - not_null
      - name: chain
        tests:
          - not_null
      - name: protocol
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v2_pool_balance_changed
    description: >
      Tracks PoolBalanceChanged events for liquidity additions/removals.
      Works across all chains - uses GLOBAL_PROJECT_NAME for chain identification.
      V2 chains: ethereum, polygon, arbitrum, gnosis
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - tx_hash
            - event_index
    columns:
      - name: tx_hash
        tests:
          - not_null
      - name: event_index
        tests:
          - not_null
      - name: chain
        tests:
          - not_null
      - name: protocol
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v2_pool_metadata
    description: >
      Tracks PoolRegistered events for pool creation and metadata.
      Works across all chains - uses GLOBAL_PROJECT_NAME for chain identification.
      V2 chains: ethereum, polygon, arbitrum, gnosis
    columns:
      - name: pool_id
        tests:
          - not_null
          - unique
      - name: chain
        tests:
          - not_null
      - name: protocol
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v2_swap_fee_changes
    description: >
      Tracks SwapFeePercentageChanged events from Balancer V2 pool contracts.
      Works across all chains - uses GLOBAL_PROJECT_NAME for chain identification.
      V2 chains: ethereum, polygon, arbitrum, gnosis
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - tx_hash
            - event_index
    columns:
      - name: tx_hash
        tests:
          - not_null
      - name: event_index
        tests:
          - not_null
      - name: chain
        tests:
          - not_null
      - name: protocol
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null

  - name: silver_protocols__balancer_v2_tvl_by_pool_and_token
    description: >
      Tracks daily token deltas from PoolBalanceChanged events.
      Works across all chains - uses GLOBAL_PROJECT_NAME for chain identification.
      V2 chains: ethereum, polygon, arbitrum, gnosis
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date
            - pool_id
            - token_address
    columns:
      - name: date
        tests:
          - not_null
      - name: pool_id
        tests:
          - not_null
      - name: token_address
        tests:
          - not_null
      - name: chain
        tests:
          - not_null
      - name: protocol
        tests:
          - not_null
      - name: modified_timestamp
        tests:
          - not_null
      - name: inserted_timestamp
        tests:
          - not_null
      - name: _invocation_id
        tests:
          - not_null
