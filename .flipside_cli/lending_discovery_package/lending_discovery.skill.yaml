name: Lending Protocol Discovery
slug: lending_discovery
description: Discover lending protocols missing from curated models and output exact CURATED_DEFI_LENDING_CONTRACT_MAPPING variable entries

tools:
  - run_sql_query
  - find_tables
  - get_table_schema

knowledge: |
  # Lending Protocol Discovery Skill

  This skill helps identify lending protocols with significant on-chain activity not yet in Flipside's curated models. It outputs the exact format needed to add new protocols to `CURATED_DEFI_LENDING_CONTRACT_MAPPING`.

  ---

  ## CURATED_DEFI_LENDING_CONTRACT_MAPPING Structure

  The mapping variable has this exact structure:
  ```python
  'CURATED_DEFI_LENDING_CONTRACT_MAPPING': {
      'protocol_name': {
          'version': {
              'type_identifier': 'contract_address'  # or ['addr1', 'addr2'] for multiple
          }
      }
  }
  ```

  ### Current Ethereum Mappings (ALREADY TRACKED)

  ```python
  'CURATED_DEFI_LENDING_CONTRACT_MAPPING': {
      'flux': {
          'v1': {'comp_v2_origin_from_address': '0x690043fb6826f9d9381c56f43971f4f044bce3aa'}
      },
      'strike': {
          'v1': {'comp_v2_origin_from_address': '0x752dfb1c709eea4621c8e95f48f3d0b6dde5d126'}
      },
      'compound': {
          'v2': {'comp_v2_origin_from_address': ['0x54a37d93e57c5da659f508069cf65a381b61e189', ...]},
          'v3': {'comp_v3_origin_from_address': ['0x343715fa797b8e9fe48b9efab4b54f01ca860e78', '0x2501713a67a3dedde090e42759088a7ef37d4eab']}
      },
      'fraxlend': {
          'v1': {'fraxlend_origin_from_address': ['0xcbc616d595d38483e6adc45c7e426f44bf230928', ...]}
      },
      'radiant': {
          'v2': {'aave_treasury': '0x28e395a54a64284dba39652921cd99924f4e3797', 'aave_version_address': '0xa950974f64aa33f27f6c5e017eee93bf7588ed07'}
      },
      'spark': {
          'v1': {'aave_treasury': '0xb137e7d16564c81ae2b0c8ee6b55de81dd46ece5', 'aave_version_address': '0xc13e21b648a5ee794902342038ff3adab66be987'}
      },
      'sturdy': {
          'v1': {'aave_treasury': '0xfd1d36995d76c0f75bbe4637c84c06e4a68bbb3a', 'aave_version_address': ['0xa422ca380bd70eef876292839222159e41aaee17','0x9f72dc67cec672bb99e3d02cbea0a21536a2b657']}
      },
      'aave': {
          'v3': {'aave_treasury': '0x464c71f6c2f760dda6093dcb91c24c39e5d6e18c', 'aave_version_address': '0x87870bca3f3fd6335c3f4ce8392d69350b4fa4e2'},
          'v2': {'aave_pool_addresses': ['0x311bb771e4f8952e6da169b425e7e92d6ac45756', '0x4e1c7865e7be78a7748724fa0409e88dc14e67aa']},
          'v2.1': {'aave_pool_addresses': '0x23a875ede3f1030138701683e42e9b16a7f87768'},
          'v1': {'aave_pool_addresses': ['0x1e70af20976b2c7e72fdc8016bcdffded12f3464', '0x4965f6fa20fe9728decf5165016fc338a5a85abf', '0xed2ebe33a237d2e2ba8bbea210616ee3d10b92db']}
      },
      'euler': {
          'v1': {'euler_origin_to_address': '0x29a56a1b8214d9cf7c5561811750d5cbdb45cc8e'}
      },
      'silo': {
          'v1': {'silo_factory': '0xb7d391192080674281baab8b3083154a5f64cd0a', 'silo_tokens_factory': '0x0e37df413f97fc198a84a21bc463c41b516ad622'},
          'v2': {'silo_factory': '0x4d919cecfd4793c0d47866c8d0a02a0950737589', 'silo_tokens_factory': '0x7ed1160719ab280760faa0ba26cf13139904cba5'}
      },
      'morpho': {
          'v1': {'morpho_blue_address': '0xbbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb'}
      }
  }
  ```

  ---

  ## Model Types and Event Signature Detection

  ### AAVE FORK (uses aave models)
  **Type identifiers**: `aave_treasury`, `aave_version_address`, `aave_pool_addresses`

  **Detect by these event signatures (topic_0)**:
  ```
  DEPOSITS:
  0xde6857219544bb5b7746f48ed30be6386fefc61b2f864cacf559893bf50fd951  -- Deposit (v1/v2)
  0x2b627736bca15cd5381dcf80b0bf11fd197d01a037c52b927a881a10fb73ba61  -- Supply (v3)

  BORROWS:
  0xc6a898309e823ee50bac64e45ca8adba6690e99e7841c45d754e2a38e9019d9b  -- Borrow v1
  0x1e77446728e5558aa1b7e81e0cdab9cc1b075ba893b740600c76a315c2caa553  -- Borrow v2
  0xb3d084820fb1a9decffb176436bd02558d15fac9b0ddfed8c465bc7359d7dce0  -- Borrow v3

  REPAYMENTS:
  0x4cdde6e09bb755c9a5589ebaec640bbfedff1362d4b255ebf8339782b9942faa  -- Repay v1/v2
  0xa534c8dbe71f871f9f3530e97a74601fea17b426cae02e1c5571e0ff6ac39bb2  -- Repay v3

  WITHDRAWS:
  0x3115d1449a7b732c986cba18244e897a450f61e1bb8d589cd2e69e6c8924f9f7  -- Withdraw v1/v2/v3

  LIQUIDATIONS:
  0xe413a321e8681d831f4dbccbca790d2952b56f977908e45be37335533e005286  -- LiquidationCall
  0x56864757fd5b1fc9f38f5f3a981cd8ae512ce41b902cf73fc506ee369c6bc237  -- LiquidationCall variant
  ```

  ### COMPOUND V2 FORK (uses comp_v2 models)
  **Type identifier**: `comp_v2_origin_from_address`

  **Detect by these event signatures (topic_0)**:
  ```
  DEPOSITS (Mint):
  0x4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f  -- Mint
  0xb4c03061fb5b7fed76389d5af8f2e0ddb09f8c70d1333abbb62582835e10accb  -- Mint variant
  0x2f00e3cdd69a77be7ed215ec7b2a36784dd158f921fca79ac29deffa353fe6ee  -- Mint fork

  BORROWS:
  0x13ed6866d4e1ee6da46f845c46d7e54120883d75c5ea9a2dacc1c4ca8984ab80  -- Borrow
  0x2dd79f4fccfd18c360ce7f9132f3621bf05eee18f995224badb32d17f172df73  -- Borrow variant

  REPAYMENTS:
  0x1a2a22cb034d26d1854bdc6666a5b91fe25efbbb5dcad3b0355478d6f5c362a1  -- RepayBorrow

  WITHDRAWS:
  0xe5b754fb1abb7f01b499791d0b820ae3b6af3424ac1c59768edb53f4ec31a929  -- Redeem

  LIQUIDATIONS:
  0x298637f684da70674f26509b10f07ec2fbc77a335ab1e7d6215a4b2484d8bb52  -- LiquidateBorrow

  ASSET DETAILS (cToken deployment):
  0x7ac369dbd14fa5ea3f473ed67cc9d598964a77501540ba6751eb0b3decf5870d  -- Deploy
  0x70aea8d848e8a90fb7661b227dc522eb6395c3dac71b63cb59edd5c9899b2364  -- Deploy variant
  ```

  ### COMPOUND V3 FORK (uses comp_v3 models)
  **Type identifier**: `comp_v3_origin_from_address`

  **Detect by these event signatures (topic_0)**:
  ```
  DEPOSITS:
  0xfa56f7b24f17183d81894d3ac2ee654e3c26388d17a28dbd9549b8114304e1f4  -- SupplyCollateral
  0xd1cf3d156d5f8f0d50f6c122ed609cec09d35c9b9fb3fff6ea0959134dae424e  -- Supply (base)

  WITHDRAWS:
  0xd6d480d5b3068db003533b170d67561494d72e3bf9b56f6c023c81a24226c53e  -- WithdrawCollateral
  ```

  ### EULER FORK (uses euler models)
  **Type identifier**: `euler_origin_to_address`

  **Detect by these event signatures (topic_0)**:
  ```
  0xdcbc1c05240f31ff3ad067ef1ee35ce4997762752e3a095284754544f4c709d7  -- Deposit
  0x0cd345140b9008a43f99a999a328ece572a0193e8c8bf5f5755585e6f293b85e  -- NewMarket
  ```

  ### FRAXLEND FORK (uses fraxlend models)
  **Type identifier**: `fraxlend_origin_from_address`

  **Detect by these event signatures (topic_0)**:
  ```
  0xa32435755c235de2976ed44a75a2f85cb01faf0c894f639fe0c32bb9455fea8f  -- AddCollateral (deposit)
  0xb7f7e57b7bb3a5186ad1bd43405339ba361555344aec7a4be01968e88ee3883e  -- PairCreated
  0x9303649990c462969a3c46d4e2c758166e92f5a4b18c67f26d3e58d2b0660e67  -- Deployment
  0xc6fa598658c9cdf9eaa5f76414ef17a38a7f74c0e719a0571a3f73d9ecd755b7  -- Deployment variant
  ```

  ### SILO FORK (uses silo models)
  **Type identifiers**: `silo_factory`, `silo_tokens_factory`

  **Detect by these event signatures (topic_0)**:
  ```
  0xdd160bb401ec5b5e5ca443d41e8e7182f3fe72d70a04b9c0ba844483d212bcb5  -- Deposit
  0x312a5e5e1079f5dda4e95dbbd0b908b291fd5b992ef22073643ab691572c5b52  -- Borrow
  0xd97e9f840332422474cda9bb0976c87735b44cda62a3fe2a4e13e2e862671812  -- CollateralToken
  0x94f128ebf0749edb8bb9d165d016ce008a16bc82cbd40cc81ded2be79140d020  -- DebtToken
  ```

  ### MORPHO (uses morpho models - TRACE-BASED)
  **Type identifier**: `morpho_blue_address`

  **Detect by function signatures (NOT event logs)**:
  ```
  0xa99aad89  -- supply
  0x50d8cd4b  -- borrow
  ```

  ---

  ## Key Tables

  ```sql
  -- Curated lending data
  SELECT * FROM {chain}.defi.ez_lending_deposits LIMIT 10;
  SELECT * FROM {chain}.defi.ez_lending_borrows LIMIT 10;

  -- Raw event logs (for discovering new protocols)
  SELECT topics[0]::STRING as topic_0, contract_address, COUNT(*)
  FROM {chain}.core.fact_event_logs
  WHERE block_timestamp >= CURRENT_DATE - 30
  GROUP BY 1, 2;

  -- Contract labels
  SELECT * FROM {chain}.core.dim_labels WHERE label_type = 'defi';

  -- Event ABI database
  SELECT event_signature, event_name FROM {chain}.silver.flat_event_abis;
  ```

  ---

  ## Discovery Queries

  ### 1. Find Protocols Using Known Event Signatures NOT in Our Mappings

  ```sql
  -- Find Aave forks not tracked (emit Aave events but not in our mapping)
  WITH aave_signatures AS (
    SELECT topic_0 FROM (VALUES
      ('0xde6857219544bb5b7746f48ed30be6386fefc61b2f864cacf559893bf50fd951'),
      ('0x2b627736bca15cd5381dcf80b0bf11fd197d01a037c52b927a881a10fb73ba61'),
      ('0xc6a898309e823ee50bac64e45ca8adba6690e99e7841c45d754e2a38e9019d9b'),
      ('0x1e77446728e5558aa1b7e81e0cdab9cc1b075ba893b740600c76a315c2caa553'),
      ('0xb3d084820fb1a9decffb176436bd02558d15fac9b0ddfed8c465bc7359d7dce0')
    ) AS t(topic_0)
  ),
  tracked_contracts AS (
    SELECT DISTINCT contract_address
    FROM ethereum.defi.ez_lending_deposits
    WHERE block_timestamp >= CURRENT_DATE - 90
  ),
  potential_aave_forks AS (
    SELECT
      e.contract_address,
      e.topics[0]::STRING as topic_0,
      COUNT(*) as event_count,
      MIN(e.block_timestamp) as first_seen,
      MAX(e.block_timestamp) as last_seen
    FROM ethereum.core.fact_event_logs e
    WHERE e.block_timestamp >= CURRENT_DATE - 90
      AND e.topics[0]::STRING IN (SELECT topic_0 FROM aave_signatures)
      AND e.contract_address NOT IN (SELECT contract_address FROM tracked_contracts)
    GROUP BY 1, 2
    HAVING COUNT(*) >= 100
  )
  SELECT
    p.*,
    l.project_name,
    l.label
  FROM potential_aave_forks p
  LEFT JOIN ethereum.core.dim_labels l ON p.contract_address = l.address
  ORDER BY event_count DESC;
  ```

  ### 2. Find Compound V2 Forks Not Tracked

  ```sql
  WITH comp_v2_signatures AS (
    SELECT topic_0 FROM (VALUES
      ('0x4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f'),
      ('0xb4c03061fb5b7fed76389d5af8f2e0ddb09f8c70d1333abbb62582835e10accb'),
      ('0x2f00e3cdd69a77be7ed215ec7b2a36784dd158f921fca79ac29deffa353fe6ee'),
      ('0x13ed6866d4e1ee6da46f845c46d7e54120883d75c5ea9a2dacc1c4ca8984ab80')
    ) AS t(topic_0)
  ),
  tracked_platforms AS (
    SELECT DISTINCT platform FROM ethereum.defi.ez_lending_deposits
  ),
  potential_comp_forks AS (
    SELECT
      e.origin_from_address,
      e.contract_address as ctoken_address,
      e.topics[0]::STRING as topic_0,
      COUNT(*) as event_count
    FROM ethereum.core.fact_event_logs e
    WHERE e.block_timestamp >= CURRENT_DATE - 90
      AND e.topics[0]::STRING IN (SELECT topic_0 FROM comp_v2_signatures)
    GROUP BY 1, 2, 3
    HAVING COUNT(*) >= 50
  )
  SELECT
    p.origin_from_address as potential_deployer,
    COUNT(DISTINCT p.ctoken_address) as num_ctokens,
    SUM(p.event_count) as total_events,
    l.project_name,
    l.label
  FROM potential_comp_forks p
  LEFT JOIN ethereum.core.dim_labels l ON p.origin_from_address = l.address
  GROUP BY 1, 4, 5
  ORDER BY total_events DESC;
  ```

  ### 3. Check Current Coverage and Volume

  ```sql
  SELECT
    platform,
    protocol,
    COUNT(*) as deposit_count,
    SUM(amount_usd) as total_usd_volume
  FROM ethereum.defi.ez_lending_deposits
  WHERE block_timestamp >= CURRENT_DATE - 30
  GROUP BY 1, 2
  ORDER BY total_usd_volume DESC;
  ```

  ### 4. Decode Unknown Event Signatures

  ```sql
  SELECT event_signature, event_name, abi
  FROM ethereum.silver.flat_event_abis
  WHERE event_signature = '0x...'  -- Replace with topic_0
  LIMIT 10;
  ```

  ---

  ## REQUIRED OUTPUT FORMAT

  When you find a missing protocol, you MUST output:

  ### 1. Model Fork Type Detection
  ```
  MODEL TYPE: [AAVE_FORK | COMPOUND_V2_FORK | COMPOUND_V3_FORK | EULER_FORK | FRAXLEND_FORK | SILO_FORK | NEW_MODEL_NEEDED]

  DETECTED BY EVENT SIGNATURES:
  - topic_0: 0x... (Event Name: ..., Count: X)
  - topic_0: 0x... (Event Name: ..., Count: Y)
  ```

  ### 2. Exact Variable Entry for ethereum_vars.sql
  ```python
  # Add to CURATED_DEFI_LENDING_CONTRACT_MAPPING in ethereum_vars.sql:

  'protocol_name': {
      'v1': {
          'type_identifier': 'contract_address'
      }
  },
  ```

  ### 3. Example for AAVE fork:
  ```python
  'new_protocol': {
      'v1': {
          'aave_treasury': '0x...',
          'aave_version_address': '0x...'
      }
  },
  ```

  ### 4. Example for COMPOUND V2 fork:
  ```python
  'new_protocol': {
      'v1': {
          'comp_v2_origin_from_address': '0x...'
      }
  },
  ```

  ### 5. Summary Table
  ```
  | Protocol | Model Type | Type Identifier | Contract Address | 30-day Events | Priority |
  |----------|------------|-----------------|------------------|---------------|----------|
  | Name     | AAVE_FORK  | aave_treasury   | 0x...            | X,XXX         | HIGH     |
  ```

  ---

  ## Workflow

  1. **Check current coverage**: Query ez_lending tables to see tracked platforms
  2. **Find missing forks**: Search for event signatures from known model types on untracked contracts
  3. **Identify deployer/factory**: For Compound V2 forks, find the `origin_from_address`; for Aave, find pool address
  4. **Cross-reference labels**: Check dim_labels for protocol identification
  5. **Output exact variable entry**: Provide copy-paste ready entry for ethereum_vars.sql
