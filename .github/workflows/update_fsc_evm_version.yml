name: Update FSC EVM Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New fsc-evm version tag (e.g., v4.5.4)'
        required: true
        type: string
      projects:
        description: 'Comma-separated repo names or "all" (default: all). The "-models" suffix is automatically added. Examples: "ethereum" or "ethereum,base"'
        required: false
        type: string
        default: 'all'
      dry_run:
        description: 'Dry run - show what would be updated without creating PRs'
        required: true
        type: boolean
        default: true

jobs:
  trigger-fsc-evm-update:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger FSC EVM Update Workflow
        run: |
          echo "Triggering FSC EVM update workflow..."
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Projects: ${{ github.event.inputs.projects }}"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.BUILD_ACTIONS_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/FlipsideCrypto/evm-build-actions/actions/workflows/update_fsc_evm_version.yml/dispatches \
            -d '{
              "ref": "main",
              "inputs": {
                "version": "${{ github.event.inputs.version }}",
                "projects": "${{ github.event.inputs.projects }}",
                "dry_run": "${{ github.event.inputs.dry_run }}"
              }
            }')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -eq 204 ]; then
            echo "✅ Workflow dispatched successfully!"
          else
            echo "❌ Failed to dispatch workflow"
            echo "HTTP Status Code: $http_code"
            echo "Response Body: $body"
            exit 1
          fi