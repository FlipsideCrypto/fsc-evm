name: Update fsc-evm Version Across Repos

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New fsc-evm version tag (e.g., v4.5.4)'
        required: true
        type: string
      projects:
        description: 'Comma-separated github_repo names or "all" (default: all)'
        required: false
        type: string
        default: 'all'
      dry_run:
        description: 'Dry run - show what would be updated without creating PRs'
        required: true
        type: boolean
        default: true

env:
  ORG: FlipsideCrypto

jobs:
  update-packages:
    runs-on: ubuntu-latest
    name: Update fsc-evm to ${{ inputs.version }}
    steps:
      - name: Checkout fsc-evm repository
        uses: actions/checkout@v4
        
      - name: Process repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Don't exit on error immediately
          set -uo pipefail
          
          VERSION="${{ inputs.version }}"
          PROJECTS="${{ inputs.projects }}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          echo "üöÄ Starting fsc-evm version update to ${VERSION}"
          echo "================================================"
          
          # Parse CSV to get active repos
          if [ ! -f "data/admin__repos.csv" ]; then
            echo "‚ùå Error: data/admin__repos.csv not found"
            exit 1
          fi
          
          # Build repo list based on input
          if [ "$PROJECTS" = "all" ]; then
            # Get all active repos (skip header, filter is_active=true, get github_repo column)
            mapfile -t REPOS < <(awk -F',' 'NR>1 && $4=="true" {print $2}' data/admin__repos.csv)
            echo "üìã Found ${#REPOS[@]} active repositories"
          else
            # Parse comma-separated list
            IFS=',' read -ra REQUESTED <<< "$PROJECTS"
            REPOS=()
            for req in "${REQUESTED[@]}"; do
              req=$(echo "$req" | xargs)  # trim
              if grep -q ",${req}," data/admin__repos.csv; then
                REPOS+=("$req")
              else
                echo "‚ö†Ô∏è  Warning: ${req} not found in data/admin__repos.csv"
              fi
            done
            echo "üìã Processing ${#REPOS[@]} requested repositories"
          fi
          
          if [ ${#REPOS[@]} -eq 0 ]; then
            echo "‚ùå No repositories to process"
            exit 1
          fi
          
          # Initialize counters
          SUCCESS_COUNT=0
          SKIP_COUNT=0
          FAIL_COUNT=0
          
          # Create results file
          RESULTS_FILE=$(mktemp)
          
          # Process each repository
          for repo in "${REPOS[@]}"; do
            FULL_REPO="${ORG}/${repo}"
            echo ""
            echo "üì¶ Processing ${repo}..."
            
            # Create temp directory
            TEMP_DIR=$(mktemp -d)
            
            # Clone repository
            if ! git clone -q "https://github.com/${FULL_REPO}.git" "${TEMP_DIR}/${repo}" 2>/dev/null; then
              echo "  ‚ùå Failed to clone repository"
              echo "${repo}|FAILED: Could not clone repository" >> "$RESULTS_FILE"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              rm -rf "$TEMP_DIR"
              continue
            fi
            
            # Save current directory
            ORIG_DIR=$(pwd)
            cd "${TEMP_DIR}/${repo}"
            
            # Check for packages.yml
            if [ ! -f "packages.yml" ]; then
              echo "  ‚ùå packages.yml not found"
              echo "${repo}|FAILED: packages.yml not found" >> "$RESULTS_FILE"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              cd "$ORIG_DIR"
              rm -rf "$TEMP_DIR"
              continue
            fi
            
            # Get current version (with trimming)
            CURRENT_VERSION=$(grep -E "revision:\s*" packages.yml | sed 's/.*revision:\s*//' | xargs)
            echo "  üìå Current version: ${CURRENT_VERSION}"
            
            # Check if already at target version
            if [ "${CURRENT_VERSION}" = "${VERSION}" ]; then
              echo "  ‚è≠Ô∏è  Already at version ${VERSION}, skipping"
              echo "${repo}|SKIPPED: Already at ${VERSION}" >> "$RESULTS_FILE"
              SKIP_COUNT=$((SKIP_COUNT + 1))
              cd "$ORIG_DIR"
              rm -rf "$TEMP_DIR"
              continue
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "  üîç [DRY RUN] Would update from ${CURRENT_VERSION} to ${VERSION}"
              echo "${repo}|DRY RUN: Would update ${CURRENT_VERSION} ‚Üí ${VERSION}" >> "$RESULTS_FILE"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              cd "$ORIG_DIR"
              rm -rf "$TEMP_DIR"
              continue
            fi
            
            # Create branch and update
            BRANCH="update-fsc-evm-${VERSION//\./-}"
            git checkout -q -b "${BRANCH}"
            
            # Update packages.yml
            sed -i "s/revision:.*/revision: ${VERSION}/" packages.yml
            
            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Commit
            git add packages.yml
            git commit -q -m "chore: update fsc-evm to ${VERSION}"
            
            # Push
            if ! git push -q origin "${BRANCH}" 2>/dev/null; then
              echo "  ‚ùå Failed to push branch"
              echo "${repo}|FAILED: Could not push branch" >> "$RESULTS_FILE"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              cd "$ORIG_DIR"
              rm -rf "$TEMP_DIR"
              continue
            fi
            
            # Create PR body
            PR_BODY=$'## üîÑ Automated fsc-evm Update\n\nThis PR updates the fsc-evm package version from `'"${CURRENT_VERSION}"'` to `'"${VERSION}"'`.\n\n### Changes\n```diff\npackages:\n  - git: https://github.com/FlipsideCrypto/fsc-evm.git\n-    revision: '"${CURRENT_VERSION}"'\n+    revision: '"${VERSION}"'\n```\n\n---\n*This PR was auto-generated by the fsc-evm version update workflow.*'
            
            # Create PR and capture output
            PR_OUTPUT=$(gh pr create \
              --repo "${FULL_REPO}" \
              --title "chore: update fsc-evm to ${VERSION}" \
              --body "$PR_BODY" \
              --base main \
              --head "${BRANCH}" 2>&1) || true
            
            if echo "$PR_OUTPUT" | grep -q "github.com"; then
              PR_URL=$(echo "$PR_OUTPUT" | grep -o 'https://github.com/[^ ]*' | head -1)
              echo "  ‚úÖ PR created: ${PR_URL}"
              echo "${repo}|SUCCESS: ${PR_URL}" >> "$RESULTS_FILE"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            elif echo "$PR_OUTPUT" | grep -q "already exists"; then
              # Get existing PR
              EXISTING_PR=$(gh pr list --repo "${FULL_REPO}" --head "${BRANCH}" --json url -q '.[0].url')
              echo "  ‚ö†Ô∏è  PR already exists: ${EXISTING_PR}"
              echo "${repo}|EXISTS: ${EXISTING_PR}" >> "$RESULTS_FILE"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "  ‚ùå Failed to create PR"
              echo "${repo}|FAILED: Could not create PR" >> "$RESULTS_FILE"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
            
            cd "$ORIG_DIR"
            rm -rf "$TEMP_DIR"
          done
          
          # Final summary
          echo ""
          echo "================================================"
          echo "üìä SUMMARY"
          echo "================================================"
          echo "Total repositories: ${#REPOS[@]}"
          echo "‚úÖ Successful: ${SUCCESS_COUNT}"
          echo "‚è≠Ô∏è  Skipped: ${SKIP_COUNT}"
          echo "‚ùå Failed: ${FAIL_COUNT}"
          
          # Detailed results
          echo ""
          echo "üìù Detailed Results:"
          echo "-------------------"
          while IFS='|' read -r repo status; do
            if [[ $status == SUCCESS* ]]; then
              echo "‚úÖ ${repo}: ${status}"
            elif [[ $status == SKIPPED* ]] || [[ $status == EXISTS* ]]; then
              echo "‚è≠Ô∏è  ${repo}: ${status}"
            elif [[ $status == "DRY RUN"* ]]; then
              echo "üîç ${repo}: ${status}"
            else
              echo "‚ùå ${repo}: ${status}"
            fi
          done < "$RESULTS_FILE" | sort
          
          # Set job summary
          {
            echo "# fsc-evm Version Update Summary"
            echo ""
            echo "**Version:** ${VERSION}"
            echo "**Total Repositories:** ${#REPOS[@]}"
            echo ""
            echo "| Status | Count |"
            echo "|--------|-------|"
            echo "| ‚úÖ Successful | ${SUCCESS_COUNT} |"
            echo "| ‚è≠Ô∏è  Skipped | ${SKIP_COUNT} |"
            echo "| ‚ùå Failed | ${FAIL_COUNT} |"
            echo ""
            echo "## Pull Requests Created"
            echo ""
            while IFS='|' read -r repo status; do
              if [[ $status == SUCCESS* ]]; then
                url="${status#SUCCESS: }"
                echo "- [${repo}](${url})"
              fi
            done < "$RESULTS_FILE" | sort
          } >> $GITHUB_STEP_SUMMARY
          
          # Clean up
          rm -f "$RESULTS_FILE"
          
          # Exit with error if any failed
          if [ $FAIL_COUNT -gt 0 ]; then
            echo ""
            echo "‚ùå Some repositories failed to update"
            exit 1
          else
            echo ""
            echo "‚ú® All repositories processed successfully!"
          fi